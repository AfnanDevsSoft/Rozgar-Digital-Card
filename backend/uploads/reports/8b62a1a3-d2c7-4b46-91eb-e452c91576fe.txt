âœ… PART 1 â€” PRODUCT, COMPLIANCE & REGULATORY GUIDANCE
(WHY we do it this way â€” for founders, PMs, and audits)
1. Product Identity Philosophy (Non-Negotiable)
Rule of the system:
â€¢ WhatsApp = User Presence & Device Proof
â€¢ Email = Legal, Billing & Account Proof
We do NOT treat WhatsApp as an account.
We treat it as a communication channel only.
Why this matters:
â€¢ WhatsApp numbers change
â€¢ WhatsApp has no identity assurance
â€¢ Regulators do not accept WhatsApp as legal identity
âœ… This aligns with:
â€¢ GDPR (EU/UK)
â€¢ Stripe SaaS best practices
â€¢ ISO 27001 (Access & Identity control)
 
2. Why OTP on WhatsApp is Allowed (but Limited)
We use WhatsApp OTP ONLY for:
â€¢ Initial verification
â€¢ Abuse prevention
â€¢ Device + number validation
We DO NOT:
â€¢ Store passwords on WhatsApp
â€¢ Do payments on WhatsApp
â€¢ Do cancellations on WhatsApp
ğŸ“Œ Reference:
â€¢ WhatsApp Business Platform Policy
â€¢ GDPR Art. 5 (data minimisation)
 
3. Free Trial Limits (Compliance-Safe)
Free trial is experience, not entitlement.
Approved limits (choose ONE):
â€¢ Max 3 voice notes
â€¢ OR 5 total minutes
â€¢ OR 7 calendar days
Whichever comes first.
Why:
â€¢ Prevents abuse
â€¢ Avoids â€œmisleading free serviceâ€ claims
â€¢ Clear value discovery
âš ï¸ Never unlimited free.
 
4. Payments & Subscription Rules (STRICT)
All payments must happen on the website.
Why:
â€¢ Stripe compliance
â€¢ PCI-DSS
â€¢ Consumer protection laws
â€¢ Chargeback defense
WhatsApp can only:
â€¢ Show plan status
â€¢ Redirect to website
â€¢ Show usage (read-only)
ğŸ“Œ Reference:
â€¢ Stripe SaaS Guidelines
â€¢ UK Consumer Contracts Regulations
â€¢ ISO 27001 A.9 (Access control)
 
5. Why Email is Mandatory for Paid Users
Email is required for:
â€¢ Invoices
â€¢ Receipts
â€¢ Refund notices
â€¢ Legal communication
â€¢ Account recovery
â€¢ Audit trail
No email = no paid plan.
This is industry standard, not optional.
 
6. What We Explicitly DO NOT Build (Tell Dev Clearly)
âŒ No subscription cancel inside WhatsApp
âŒ No payment collection inside WhatsApp
âŒ No refunds inside WhatsApp
âŒ No WhatsApp-only accounts
âŒ No anonymous recurring billing
These are legal risk zones.
 
7. Compliance Summary (For Auditors)
Karsaaz Agent:
â€¢ Uses data minimisation
â€¢ Stores no raw audio
â€¢ Uses passwordless login
â€¢ Separates channel vs identity
â€¢ Uses Stripe for billing
â€¢ Provides clear user consent
âœ” GDPR
âœ” ISO-27001 aligned
âœ” WhatsApp Policy aligned
âœ” Stripe compliant
 
ğŸ”§ PART 2 â€” TECHNICAL STEP-BY-STEP IMPLEMENTATION
(WHAT the developer must build â€” exact flow)
 
STEP 1 â€” WhatsApp Onboarding (Entry Gate)
Trigger: User sends message to bot
Flow:
1. Generate OTP
2. Send OTP via WhatsApp
3. Verify OTP
4. Create temporary user record
{
 "user_id": "uuid",
 "whatsapp_number": "+44xxxx",
 "whatsapp_verified": true,
 "account_status": "TRIAL",
 "email": null
}
 
STEP 2 â€” Trial Usage Enforcement
Each voice message:
â€¢ Check remaining trial quota
â€¢ If available â†’ process
â€¢ If exceeded â†’ block + redirect
trial_minutes_used
trial_message_count
trial_expires_at
 
STEP 3 â€” Paywall Trigger (Soft Stop)
When limit reached:
â€¢ WhatsApp message with Subscribe button
â€¢ Link includes secure token
Example:
https://karsaazagent.com/subscribe?token=XYZ
Token maps to user_id.
 
STEP 4 â€” Website Login (Email Binding)
Preferred Method: Email OTP (Passwordless)
Flow:
1. User enters email
2. Send OTP to email
3. Verify OTP
4. Bind email to user
{
 "email": "user@email.com",
 "email_verified": true,
 "login_method": "EMAIL_OTP"
}
Optional:
â€¢ Google OAuth (same binding rules)
 
STEP 5 â€” WhatsApp + Email Binding (LOCK)
Once email verified:
â€¢ Lock WhatsApp number
â€¢ Lock email
â€¢ Enable billing
{
 "whatsapp_locked": true,
 "email_locked": true,
 "billing_enabled": true
}
âš ï¸ One WhatsApp â†’ One Email â†’ One User ID
 
STEP 6 â€” Stripe Subscription
Stripe flow:
â€¢ Create customer
â€¢ Attach email
â€¢ Create subscription
â€¢ Store subscription ID
{
 "stripe_customer_id": "cus_xxx",
 "subscription_id": "sub_xxx",
 "plan": "BUSINESS"
}
 
STEP 7 â€” WhatsApp After Payment
WhatsApp shows:
â€¢ Plan name
â€¢ Remaining minutes
â€¢ Link to manage billing (website)
âŒ No billing actions inside WhatsApp.
 
STEP 8 â€” CRM & Audit Logs
Every action logs:
â€¢ Timestamp
â€¢ User ID
â€¢ Action
â€¢ Source (WhatsApp / Web)
ISO-ready.
 
ğŸ§  FINAL MESSAGE FOR YOUR DEVELOPER (You can paste this)
â€œBuild WhatsApp as a controlled entry channel, not an account system.
Email is mandatory for paid users.
Stripe handles money.
WhatsApp never handles payments, cancellations, or refunds.
Every user must end up with ONE WhatsApp + ONE email + ONE user ID.
No exceptions.â€
 
If you want next:
â€¢ âœ… Database schema (tables + fields)
â€¢ âœ… WhatsApp message wording (legal-safe)
â€¢ âœ… Website UI copy (compliance-friendly)
â€¢ âœ… Free-trial config table
 
 
1) âœ… Database Schema (Minimal + Compliance-Safe)
A) users
Purpose: Core identity (email = legal anchor)
â€¢ id (UUID, PK)
â€¢ email (varchar, unique, nullable until paid)
â€¢ email_verified (bool, default false)
â€¢ primary_login_method (enum: EMAIL_OTP, GOOGLE_OAUTH)
â€¢ status (enum: TRIAL, ACTIVE, SUSPENDED, CLOSED)
â€¢ created_at, updated_at
â€¢ last_login_at
â€¢ timezone (varchar, nullable)
â€¢ locale (varchar, nullable)
Rules
â€¢ Paid/Active Ú©ÛŒÙ„Ø¦Û’ email + email_verified=true Ù„Ø§Ø²Ù…ÛŒ
â€¢ Trial Ù…ÛŒÚº email=null allowed
 
B) whatsapp_identities
Purpose: WhatsApp as channel proof (not legal identity)
â€¢ id (UUID, PK)
â€¢ user_id (UUID, FK -> users.id)
â€¢ wa_number_e164 (varchar, unique) // +44â€¦
â€¢ wa_verified (bool, default false)
â€¢ wa_verified_at (timestamp, nullable)
â€¢ link_status (enum: PENDING, LINKED, BLOCKED)
â€¢ last_seen_at (timestamp)
Rules
â€¢ One WhatsApp number â†’ One user_id (unique)
 
C) otp_challenges
Purpose: OTP tracking (rate limit + audit)
â€¢ id (UUID, PK)
â€¢ channel (enum: WHATSAPP, EMAIL)
â€¢ destination (varchar) // phone or email
â€¢ code_hash (varchar)
â€¢ expires_at (timestamp)
â€¢ attempts (int, default 0)
â€¢ max_attempts (int, default 5)
â€¢ status (enum: SENT, VERIFIED, EXPIRED, LOCKED)
â€¢ created_at
â€¢ verified_at (timestamp, nullable)
â€¢ ip (varchar, nullable)
â€¢ user_agent (text, nullable)
Rules
â€¢ OTP plaintext store Ù†Û Ú©Ø±ÛŒÚºâ€”hash only
â€¢ attempts exceed â†’ LOCKED
 
D) plans
Purpose: Your product catalog
â€¢ id (UUID, PK)
â€¢ code (varchar, unique) // FREE, BASIC, BUSINESS
â€¢ monthly_minutes (int)
â€¢ price_cents (int)
â€¢ currency (varchar) // GBP/AED/USD
â€¢ is_active (bool)
 
E) subscriptions
Purpose: Stripe state = source of truth
â€¢ id (UUID, PK)
â€¢ user_id (UUID, FK)
â€¢ plan_id (UUID, FK)
â€¢ stripe_customer_id (varchar)
â€¢ stripe_subscription_id (varchar, unique)
â€¢ status (enum: TRIALING, ACTIVE, PAST_DUE, CANCELED, UNPAID)
â€¢ current_period_start (timestamp)
â€¢ current_period_end (timestamp)
â€¢ cancel_at_period_end (bool, default false)
â€¢ created_at, updated_at
Rule
â€¢ Website â€œManage Billingâ€ ØµØ±Ù Stripe portal link Ø¯Û’
 
F) usage_ledger
Purpose: minutes consumption (audit + disputes)
â€¢ id (UUID, PK)
â€¢ user_id (UUID, FK)
â€¢ source (enum: WHATSAPP, TELEGRAM, WEB)
â€¢ event_type (enum: TRANSCRIBE, SUMMARY, TTS)
â€¢ minutes_billed (decimal(10,2))
â€¢ request_id (varchar, unique) // idempotency
â€¢ created_at
 
G) trial_policy
Purpose: Trial rules (no code change)
â€¢ id (UUID, PK)
â€¢ max_messages (int) default 3
â€¢ max_minutes (decimal(10,2)) default 5.00
â€¢ max_days (int) default 7
â€¢ enforced_mode (enum: FIRST_HIT_WINS, ALL)
o FIRST_HIT_WINS = Ø¬Ùˆ Ù¾ÛÙ„Û’ limit hit ÛÙˆØŒ trial Ø¨Ù†Ø¯
o ALL = ØªÛŒÙ†ÙˆÚº limit check ÛÙˆÚº
 
H) audit_logs
Purpose: ISO/GDPR audit trail
â€¢ id (UUID, PK)
â€¢ user_id (UUID, nullable)
â€¢ actor (enum: USER, SYSTEM, ADMIN)
â€¢ action (varchar) // OTP_SENT, WA_LINKED, SUB_CREATED
â€¢ metadata_json (json)
â€¢ created_at
â€¢ ip (varchar, nullable)
Rule
â€¢ No audio content in logs
 
2) âœ… WhatsApp Message Wording (Legal-Safe + Simple)
A) First Contact (Before OTP)
Bot:
â€œHi! I can convert voice notes to text & short summaries.
To start, Iâ€™ll verify this number with a one-time code.
Reply: startâ€
 
B) OTP Send
Bot:
â€œYour verification code is: 123456
It expires in 5 minutes.
If you didnâ€™t request this, ignore this message.â€
 
C) Trial Active (After OTP Verified)
Bot:
â€œâœ… Verified. Youâ€™re on Free Trial.
Send a voice note now.
Trial limits apply (minutes/messages).â€
(ÛŒÛØ§Úº long policy Ù†Û Ù„Ú©Ú¾ÛŒÚºâ€”Ø¨Ø³ short)
 
D) Trial Limit Hit (Paywall)
Bot:
â€œYouâ€™ve reached your free trial limit.
To continue, upgrade here: [Subscribe]
Billing is handled on our website for security.â€
 
E) Paid User Reminder (Email Required)
Bot (when user tries paid without email):
â€œTo activate a paid plan, we need an email for receipts & account access.
Tap [Complete Signup].â€
 
F) Plan / Usage Commands (Read-Only)
/usage
â€œPlan: BUSINESS
Remaining minutes: 120
Manage billing: [Open Website]â€
/profile
â€œName: â€¦
Email: â€¦
WhatsApp: Linkedâ€
 
G) Cancellation/Refund Handling (Stay clean)
If user asks cancel in WhatsApp:
â€œFor security, subscription changes are managed on the website: [Manage Subscription]â€
No debate. No extra text.
 
3) âœ… Developer Guardrails (Must Implement)
Rate Limits
â€¢ WhatsApp OTP: max 3 per hour per number
â€¢ Email OTP: max 5 per hour per email
â€¢ Voice processing: per plan quota
Data Retention (Simple but safe)
â€¢ Raw audio: do not persist
â€¢ Transcripts/summaries: store only if user enabled â€œNotesâ€
â€¢ Logs: keep metadata only, no content
Consent
Website signup page checkbox:
â€¢ â€œI agree to Terms & Privacy Policyâ€
â€¢ â€œI consent to processing voice notes to generate text/summariesâ€
 
4) Quick Decisions (So team doesnâ€™t stall)
âœ… Best default:
â€¢ Trial via WhatsApp OTP
â€¢ Paid via Email OTP (passwordless) + Stripe
â€¢ Google OAuth optional later
âŒ Donâ€™t do:
â€¢ â€œPaid via WhatsApp OTP onlyâ€
â€¢ â€œCancel inside WhatsAppâ€
 
 
PART 3/3 â€” Technical Implementation (APIs + Webhooks + Compliance Text)
1) âœ… API Endpoints (Backend Contract)
A) WhatsApp OTP (Trial Identity Proof)
POST /v1/auth/wa/start
â€¢ Input: { wa_number_e164 }
â€¢ Action: create otp_challenges (WHATSAPP), send OTP via WhatsApp template
â€¢ Output: { challenge_id, expires_at }
POST /v1/auth/wa/verify
â€¢ Input: { challenge_id, otp_code }
â€¢ Action:
o verify OTP hash
o upsert users (if not exist) in TRIAL
o upsert whatsapp_identities link to user
o create session
â€¢ Output: { session_token, user_id, status:"TRIAL" }
Security
â€¢ OTP hash only
â€¢ attempts lock
â€¢ anti-bruteforce by IP + wa_number
 
B) Email Login (Paid Anchor / Compliance Anchor)
POST /v1/auth/email/start
â€¢ Input: { email }
â€¢ Action: send Email OTP
â€¢ Output: { challenge_id }
POST /v1/auth/email/verify
â€¢ Input: { challenge_id, otp_code }
â€¢ Action:
o verify email
o set users.email, email_verified=true
o if WhatsApp already linked â†’ merge into same user_id
â€¢ Output: { session_token, user_id }
Merge Rule (important)
â€¢ If email OTP verified and WA already linked under another trial user:
o require a â€œlink-confirmâ€ step inside WhatsApp or a signed one-time token from website
o then merge user records safely (prevent account takeover)
 
C) WhatsApp Linking (Website â†’ WhatsApp)
POST /v1/link/wa/create-code
â€¢ Auth: logged-in user (website)
â€¢ Output: { link_code, expires_at } (6 digits or short code)
POST /v1/link/wa/confirm
â€¢ Called when user sends: link CODE on WhatsApp
â€¢ Input: { wa_number_e164, link_code }
â€¢ Action: attach WA number to logged-in user_id (from link_code record)
â€¢ Output: { linked:true }
Why this is gold:
Ø§Ø³ Ø³Û’ WhatsApp Ù¾Ø± Ú©Ø¨Ú¾ÛŒ â€œpaid identityâ€ Ù†ÛÛŒÚº Ø¨Ù†ØªÛŒØŒ ØµØ±Ù channel link Ø¨Ù†ØªØ§ ÛÛ’Û” compliance strong.
 
D) Usage + Quota
GET /v1/usage/summary
â€¢ Output: { plan, minutes_remaining, period_end }
POST /v1/usage/consume
â€¢ Input: { request_id, event_type, minutes_billed, source }
â€¢ Action: insert into usage_ledger (idempotent by request_id)
 
E) Voice Processing (internal)
POST /v1/voice/process
â€¢ Input: { source, audio_url, output_mode, lang_primary, lang_secondary }
â€¢ Flow:
1. fetch audio stream
2. transcribe (Whisper)
3. summarise (<=5 bullets)
4. optional TTS if premium
5. write usage_ledger
â€¢ Output: { transcript, summary, audio_summary_url? }
Critical Compliance Rule
â€¢ audio_url is temporary signed URL
â€¢ audio deleted immediately after processing (no persistence)
 
2) âœ… Stripe Webhook Mapping (Source of Truth)
Webhook Endpoint
POST /v1/webhooks/stripe
â€¢ Verify signature (Stripe signing secret mandatory)
Events to Handle
1. checkout.session.completed
â€¢ Create/attach stripe_customer_id
â€¢ Create subscription record (status pending until sub event)
2. customer.subscription.created
â€¢ Upsert subscriptions
â€¢ status â†’ ACTIVE or TRIALING
3. customer.subscription.updated
â€¢ Update status, cancel_at_period_end, period dates
4. invoice.payment_succeeded
â€¢ Keep as confirmation; update ACTIVE
5. invoice.payment_failed
â€¢ status â†’ PAST_DUE
â€¢ WhatsApp message: â€œPayment issue â€” manage billing on websiteâ€
6. customer.subscription.deleted
â€¢ status â†’ CANCELED
â€¢ downgrade access
Access Rules (Enforcement)
â€¢ ACTIVE/TRIALING â†’ allow premium features
â€¢ PAST_DUE â†’ grace period (e.g., 3 days) then restrict
â€¢ CANCELED/UNPAID â†’ restrict to free mode
 
3) âœ… Trial Limits (Recommended Defaults)
ÛŒÛ safe Ø¨Ú¾ÛŒ ÛÛ’ Ø§ÙˆØ± user-friendly Ø¨Ú¾ÛŒ:
â€¢ max_messages = 3
â€¢ max_minutes = 5.0
â€¢ max_days = 7
â€¢ Enforcement: FIRST_HIT_WINS
Why:
Trial abuse Ú©Ù…ØŒ support load Ú©Ù…ØŒ Ø§ÙˆØ± â€œÛÙ… Ù†Û’ free Ø¯Û’ Ø¯ÛŒØ§ ØªÚ¾Ø§â€ ÙˆØ§Ù„Ø§ drama Ø®ØªÙ…Û”
 
4) âœ… WhatsApp Business API Compliance (Your Bot Reality)
Must do
â€¢ OTP as approved WhatsApp template (transactional)
â€¢ Opt-in: user sends â€œstartâ€ first (or website opt-in) before you message
â€¢ Provide â€œSTOPâ€ / â€œUNSUBSCRIBEâ€ command
â€¢ No marketing spam to cold users
Donâ€™t do
â€¢ â€œPaid subscription management inside WhatsAppâ€
â€¢ Long terms/policies as chat spam
 
5) âœ… Short Legal/Compliance Copy (Website Only)
A) Terms (Short)
Service Description
â€œKarsaazAgent converts user-submitted voice notes into text and short summaries.â€
No Legal Reliance
â€œOutputs may contain errors. Do not rely on summaries as legal, medical, or financial advice.â€
User Responsibility
â€œYou confirm you have the right to share the audio content you submit.â€
Subscription
â€œPayments and subscription changes are managed via our website billing portal.â€
Refunds
â€œRefund policy is defined on the billing page and applies per plan.â€
 
B) Privacy (Short)
Data We Process
â€¢ WhatsApp number (for linking)
â€¢ Email (for account + receipts)
â€¢ Usage metrics (minutes, plan)
â€¢ Transcripts/summaries only if Notes is enabled
Audio Retention
â€œWe do not store raw audio after processing.â€
Lawful Basis
â€¢ Contract performance (providing service)
â€¢ Legitimate interests (security, fraud prevention)
â€¢ Consent (optional features like Notes)
User Rights
â€¢ Access, deletion, export requests through support email (legal domain)
 
C) WhatsApp In-Chat Minimal Disclosures (1â€“2 lines only)
When user first starts:
â€œBy using this bot, you agree to our Terms and Privacy Policy: [link].â€
Ø¨Ø³Û” Ø®ØªÙ…Û” WhatsApp Ù¾Ø± law lecture Ù†ÛÛŒÚºÛ”
 
6) âœ… ISO/GDPR/PDPL â€œMust-Have Controlsâ€ (Dev Checklist)
â€¢ âœ… Audit logs for auth/link/subscription actions
â€¢ âœ… No raw audio storage
â€¢ âœ… Data minimization: WhatsApp used as channel, not identity
â€¢ âœ… Access control: admin actions logged
â€¢ âœ… Encryption in transit (TLS) + encryption at rest
â€¢ âœ… DPA/contracts with processors (Stripe + WhatsApp provider + OpenAI/Whisper provider)
â€¢ âœ… DPIA-lite doc (1 pager) for launch
 
7) Final Recommended Architecture Decision (So you donâ€™t overthink)
Trial: WhatsApp OTP âœ…
Paid: Email OTP + Stripe âœ…
WhatsApp: channel link only âœ…
Cancel/Refund: website only âœ…
Policies: website only âœ…
WhatsApp text: minimal + commands only âœ…
 
Karsaaz Agent â€” Developer Handoff (v1.0)
Goal: WhatsApp-first product experience, website-only for legal + billing, email mandatory for paid, Stripe as source of truth.
0) Non-Negotiables (Do / Donâ€™t)
âœ… DO
â€¢ WhatsApp = interaction + trial
â€¢ Website = signup + consent + billing + cancel/refund
â€¢ Email = mandatory for paid
â€¢ Stripe Checkout + Webhooks = subscription truth
â€¢ Minimal WhatsApp legal text + commands that link to website
âŒ DONâ€™T
â€¢ No payments in WhatsApp
â€¢ No cancel/refund in WhatsApp
â€¢ No recurring without verified email
â€¢ No raw audio storage
â€¢ No storing OTP plaintext (hash only)
 
1) Identity Model (Binding Rules)
â€¢ Primary channel: WhatsApp number (E.164)
â€¢ Legal/Billing identity: Email (verified) + Stripe customer/subscription IDs
â€¢ Binding: 1 WhatsApp â†” 1 user_id â†” 1 email (for paid)
States:
â€¢ TRIAL: WhatsApp verified, email can be null
â€¢ ACTIVE: email_verified = true AND Stripe subscription ACTIVE/TRIALING
â€¢ PAST_DUE/CANCELED: restrict premium
 
2) Trial Limits (Default)
Choose FIRST_HIT_WINS enforcement:
â€¢ max voice notes: 3
â€¢ max minutes: 5.0
â€¢ max days: 7
When any limit hits â†’ show Subscribe CTA (website link with token).
 
3) Minimal DB Tables (Must Have)
â€¢ users(id, email, email_verified, status, created_atâ€¦)
â€¢ whatsapp_identities(user_id, wa_number_e164 unique, wa_verifiedâ€¦)
â€¢ otp_challenges(channel, destination, code_hash, expires_at, attempts, statusâ€¦)
â€¢ plans(code, monthly_minutes, price_cents, currencyâ€¦)
â€¢ subscriptions(user_id, stripe_customer_id, stripe_subscription_id unique, status, period_start/end, cancel_at_period_endâ€¦)
â€¢ usage_ledger(user_id, request_id unique, event_type, minutes_billed, created_atâ€¦)
â€¢ audit_logs(user_id, action, metadata_json, created_at, ipâ€¦)
 
4) API Endpoints (Contract)
WhatsApp OTP
â€¢ POST /v1/auth/wa/start {wa_number_e164} â†’ send OTP (WA template), returns challenge_id
â€¢ POST /v1/auth/wa/verify {challenge_id, otp} â†’ create/return user_id, set TRIAL
Email OTP (Paid anchor)
â€¢ POST /v1/auth/email/start {email} â†’ send email OTP
â€¢ POST /v1/auth/email/verify {challenge_id, otp} â†’ set email_verified=true
Linking (Website â†’ WhatsApp)
â€¢ POST /v1/link/wa/create-code (auth) â†’ {link_code}
â€¢ POST /v1/link/wa/confirm {wa_number_e164, link_code} â†’ bind WA to user
Usage
â€¢ GET /v1/usage/summary
â€¢ POST /v1/usage/consume {request_id, event_type, minutes_billed} (idempotent)
Voice Processing
â€¢ POST /v1/voice/process {audio_url, output_mode, lang_primary, lang_secondary, source}
o fetch stream â†’ transcribe â†’ summarize (<=5 bullets) â†’ optional TTS (premium)
o delete audio immediately after processing
o write usage_ledger
 
5) Stripe Webhooks (Source of Truth)
Endpoint: POST /v1/webhooks/stripe (verify signature)
Handle:
â€¢ checkout.session.completed â†’ attach customer id
â€¢ customer.subscription.created/updated/deleted â†’ upsert subscription status/periods
â€¢ invoice.payment_succeeded â†’ ensure ACTIVE
â€¢ invoice.payment_failed â†’ PAST_DUE (+ WhatsApp notice linking billing page)
Access gating:
â€¢ ACTIVE/TRIALING â†’ premium ON
â€¢ PAST_DUE â†’ grace 3 days â†’ then restrict
â€¢ CANCELED/UNPAID â†’ restrict to free
 
6) Website Pages (Minimal)
1. /signup
o Email OTP login
o Consent checkboxes (not pre-checked):
â–ª Terms + Privacy
â–ª Recurring billing consent (only on paid)
2. /subscribe
o Stripe Checkout
3. /billing
o Stripe Customer Portal (manage/cancel/refund policy link)
4. /privacy /terms /contact
Rule: user can use WhatsApp trial without email, but cannot subscribe without verified email.
 
7) WhatsApp Bot Copy (Minimal, Safe)
Start
â€œHi! I convert voice notes to text & short summaries. Reply start to verify.â€
After verify
â€œâœ… Verified. Youâ€™re on Free Trial. Send a voice note.â€
Limit reached
â€œTrial limit reached. Upgrade securely here: [Subscribe]. Billing is managed on our website.â€
Cancel request in WA
â€œFor security, subscription changes are managed on our website: [Manage Billing].â€
Commands (read-only):
â€¢ help/menu, usage, plan, profile, how
Optional compliance commands (link-only):
â€¢ privacy, terms, delete (delete triggers website flow or support email)
 
8) Security & Compliance Controls
â€¢ OTP: hash only + attempts lock + rate limits
â€¢ No raw audio persistence
â€¢ Encrypt at rest + TLS
â€¢ Audit logs for: OTP sent/verified, link created/confirmed, subscription changes, admin actions
â€¢ Data minimization: WA is channel, email is billing anchor
â€¢ Do not claim WhatsApp/Telegram affiliation
 
9) Definition of Done (Launch Gate)
â€¢ Trial limits enforced âœ…
â€¢ Subscribe requires verified email âœ…
â€¢ Stripe webhooks fully synced âœ…
â€¢ Billing portal works âœ…
â€¢ WhatsApp shows only read-only billing status âœ…
â€¢ Privacy/Terms accessible âœ…
â€¢ Audio not stored âœ…
â€¢ Audit logs exist âœ…
 
 
1) Sequence Diagrams
A) WhatsApp Trial (OTP) â†’ Free Use
User -> WhatsApp Bot: "start"
Bot -> Backend: /auth/wa/start (wa_number)
Backend -> WhatsApp API: Send OTP template
User -> Bot: "otp 123456"
Bot -> Backend: /auth/wa/verify
Backend -> DB: upsert user(TRIAL) + whatsapp_identity(LINKED)
Backend -> Bot: "Verified + Trial active"
User -> Bot: (forwards voice note)
Bot -> Backend: /voice/process (audio_url)
Backend -> Whisper: transcribe
Backend -> LLM: summarize <=5 bullets
Backend -> DB: usage_ledger consume
Backend -> Bot: transcript + summary
B) Trial Limit Hit â†’ Subscribe (Website) â†’ Auto Access
Backend -> Bot: "Trial limit reached" + [Subscribe link with token]
 
User -> Website: /subscribe?token=XYZ
Website -> Backend: validate token -> user_id
Website -> Backend: /auth/email/start
Backend -> Email: send OTP
User -> Website: enter OTP
Website -> Backend: /auth/email/verify (bind email)
Website -> Stripe: Checkout
Stripe -> Backend(webhook): checkout.session.completed
Stripe -> Backend(webhook): customer.subscription.created
Backend -> DB: subscriptions ACTIVE + user ACTIVE
Backend -> WhatsApp Bot: "âœ… Plan active" (optional)
User -> Bot: send voice -> premium allowed
C) Renewal / Payment Failure (Stripe â†’ WhatsApp Notice)
Stripe -> Backend(webhook): invoice.payment_failed
Backend -> DB: subscription PAST_DUE
Backend -> WhatsApp Bot: "Payment issue. Manage billing: [link]"
(Grace period)
Stripe -> Backend(webhook): invoice.payment_succeeded
Backend -> DB: ACTIVE
 
2) JSON Payload Samples (copy-paste ready)
A) /v1/auth/wa/start
Request
{ "wa_number_e164": "+971501234567" }
Response
{ "challenge_id": "ch_wa_01H...", "expires_at": "2025-12-13T09:10:00Z" }
B) /v1/auth/wa/verify
Request
{ "challenge_id": "ch_wa_01H...", "otp_code": "123456" }
Response
{
 "session_token": "sess_01H...",
 "user_id": "usr_01H...",
 "status": "TRIAL",
 "whatsapp_verified": true
}
C) /v1/link/wa/create-code (Website auth)
Response
{ "link_code": "A93K21", "expires_at": "2025-12-13T09:30:00Z" }
D) /v1/link/wa/confirm
Request
{ "wa_number_e164": "+971501234567", "link_code": "A93K21" }
Response
{ "linked": true, "user_id": "usr_01H..." }
E) /v1/auth/email/start
Request
{ "email": "user@example.com" }
Response
{ "challenge_id": "ch_em_01H...", "expires_at": "2025-12-13T09:12:00Z" }
F) /v1/auth/email/verify
Request
{ "challenge_id": "ch_em_01H...", "otp_code": "829104" }
Response
{ "session_token": "sess_01H...", "user_id": "usr_01H...", "email_verified": true }
G) /v1/voice/process
Request
{
 "source": "WHATSAPP",
 "audio_url": "https://cdn.../signed-url",
 "output_mode": "TEXT_ONLY",
 "lang_primary": "en",
 "lang_secondary": "ur",
 "request_id": "req_20251213_000001"
}
Response
{
 "transcript": "....",
 "summary_bullets": ["...", "...", "..."],
 "audio_summary_url": null
}
H) /v1/usage/consume (idempotent)
Request
{
 "request_id": "req_20251213_000001",
 "event_type": "SUMMARY",
 "minutes_billed": 0.75,
 "source": "WHATSAPP"
}
Response
{ "accepted": true }
 
3) Stripe Webhook Samples (minimum fields you must use)
A) checkout.session.completed
{
 "type": "checkout.session.completed",
 "data": { "object": {
   "id": "cs_test_...",
   "customer": "cus_...",
   "metadata": { "user_id": "usr_01H..." }
 }}
}
B) customer.subscription.created
{
 "type": "customer.subscription.created",
 "data": { "object": {
   "id": "sub_...",
   "customer": "cus_...",
   "status": "active",
   "current_period_start": 1765610000,
   "current_period_end": 1768288400,
   "cancel_at_period_end": false,
   "metadata": { "user_id": "usr_01H..." }
 }}
}
C) invoice.payment_failed
{
 "type": "invoice.payment_failed",
 "data": { "object": {
   "customer": "cus_...",
   "subscription": "sub_..."
 }}
}
Implementation rules
â€¢ Webhook signature verify Ù„Ø§Ø²Ù…ÛŒ
â€¢ subscription status Ú©Ø§ source = Stripe (DB Ù†ÛÛŒÚº)
 
4) QA / Test Plan (Launch Gate Checklist)
A) WhatsApp OTP & Trial
â€¢ OTP send works (template approved)
â€¢ OTP expires at 5 min
â€¢ Max attempts lock (5 tries)
â€¢ Rate limit: 3 OTP/hour/number
â€¢ After verify user created (TRIAL)
â€¢ Trial minutes/messages decrement correctly
â€¢ Trial limit hit triggers Subscribe CTA
â€¢ Trial cannot be reset by reinstall (number-based + heuristics)
B) Linking & Account Binding
â€¢ Website link_code binds correct WA number
â€¢ Expired link_code rejected
â€¢ link_code single-use only
â€¢ One WA cannot link to multiple users
â€¢ One email cannot bind to multiple users (unless you explicitly allow)
â€¢ Merge safety: if email already in use â†’ prompt â€œlogin insteadâ€ (no takeover)
C) Email OTP + Paid Activation
â€¢ Email OTP send/verify works
â€¢ Paid checkout blocked until email_verified=true
â€¢ Consent checkbox required (not pre-ticked)
â€¢ After payment: webhook updates subscription ACTIVE
â€¢ WhatsApp premium features unlocked only after webhook (not after redirect)
D) Stripe Billing & Renewals
â€¢ payment_succeeded keeps ACTIVE
â€¢ payment_failed switches to PAST_DUE + WhatsApp notice
â€¢ Grace period logic works (e.g., 3 days)
â€¢ After grace: premium locked
â€¢ Cancellation in Stripe portal reflects in product access (webhook)
â€¢ Refund flow does not break access incorrectly (define rules)
E) Data Handling & Security
â€¢ Raw audio never stored (verify no S3 bucket persistence)
â€¢ Signed audio URL TTL short (e.g., 5â€“10 min)
â€¢ Logs never contain audio/transcript content
â€¢ PII minimized (store WA + email only)
â€¢ /delete deletes transcripts/notes + unlinks WA (policy-defined)
â€¢ Admin actions are audited
F) UX & Illiterate User Checks
â€¢ WhatsApp messages short, clear
â€¢ Subscribe flow is max 2â€“3 screens
â€¢ Manage billing link always available
â€¢ No scary legal paragraphs in WhatsApp
 
5) Edge Cases (Must test)
â€¢ SIM change / number recycled â†’ block takeover (require re-verify + email match)
â€¢ User tries to subscribe without email â†’ forced email step
â€¢ User links wrong WhatsApp number â†’ reject (must match verified number)
â€¢ Duplicate webhook events â†’ idempotent updates
 